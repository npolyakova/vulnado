name: Security Scan Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      origin_id:
        description: 'Pipeline ID'
        required: true
        default: ''

env:
  API_BASE_URL: 'https://short-points-love.loca.lt'
  UPLOAD_ENDPOINT: '/scanner-reports/upload'
  GENERATE_ENDPOINT: '/reports/generate'
  
jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    outputs:
      pipeline_id: ${{ steps.set_ids.outputs.pipeline_id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set IDs
        id: set_ids
        run: |
          if [[ -n "${{ github.event.inputs.origin_id }}" ]]; then
            PIPELINE_ID="${{ github.event.inputs.origin_id }}"
          else
            PIPELINE_ID="${GITHUB_RUN_ID}-${GITHUB_RUN_NUMBER}"
          fi
          echo "pipeline_id=${PIPELINE_ID}" >> $GITHUB_OUTPUT
          echo "origin_id=${PIPELINE_ID}" >> $GITHUB_ENV
          echo "Using pipeline ID: ${PIPELINE_ID}"
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install bandit semgrep
      
      - name: Setup Trivy
        run: |
          wget https://github.com/aquasecurity/trivy/releases/download/v0.49.1/trivy_0.49.1_Linux-64bit.deb
          sudo dpkg -i trivy_0.49.1_Linux-64bit.deb
          trivy --version
      
      - name: Create reports directory
        run: mkdir -p reports
      
      # –ó–∞–ø—É—Å–∫ Trivy —Å–∫–∞–Ω–µ—Ä–∞
      - name: Run Trivy filesystem scan
        run: |
          trivy filesystem \
            --scanners vuln,secret,misconfig \
            --format sarif \
            --output reports/trivy-report.sarif \
            --exit-code 0 \
            .
      
      # –ó–∞–ø—É—Å–∫ Bandit (Python)
      - name: Run Bandit security scanner
        run: |
          bandit -r . \
            -f sarif \
            -o reports/bandit-report.sarif \
            --exit-zero \
            || true
      
      # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å Semgrep (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω Semgrep –≤–º–µ—Å—Ç–æ Bandit)
      # - name: Run Semgrep
      #   run: |
      #     semgrep ci \
      #       --config auto \
      #       --sarif \
      #       --output reports/semgrep-report.sarif \
      #       --quiet \
      #       || true
      
      # –ó–∞–≥—Ä—É–∑–∫–∞ Trivy –æ—Ç—á–µ—Ç–∞
      - name: Upload Trivy report
        id: upload_trivy
        continue-on-error: true
        run: |
          curl -X 'POST' \
            "https://short-points-love.loca.lt/scanner-reports/upload" \
            -H 'accept: application/json' \
            -H 'Content-Type: multipart/form-data' \
            -F 'file=@reports/trivy-report.sarif' \
            -F 'scanner_type=trivy' \
            -F 'origin_id=${{ env.origin_id }}' \
            -F 'project_name=${{ github.repository }}' \
            -F 'user_id=1'
      
      # –ó–∞–≥—Ä—É–∑–∫–∞ Bandit –æ—Ç—á–µ—Ç–∞
      - name: Upload Bandit report
        id: upload_bandit
        continue-on-error: true
        run: |
          curl -X 'POST' \
            "https://short-points-love.loca.lt/scanner-reports/upload" \
            -H 'accept: application/json' \
            -H 'Content-Type: multipart/form-data' \
            -F 'file=@reports/bandit-report.sarif' \
            -F 'scanner_type=bandit' \
            -F 'origin_id=${{ env.origin_id }}' \
            -F 'project_name=${{ github.repository }}' \
            -F 'user_id=1'
      
      # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è Semgrep (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
      # - name: Upload Semgrep report
      #   run: |
      #     curl -X 'POST' \
      #       "${API_BASE_URL}${UPLOAD_ENDPOINT}" \
      #       -H 'accept: application/json' \
      #       -H 'Content-Type: multipart/form-data' \
      #       -F 'file=@reports/semgrep-report.sarif' \
      #       -F 'scanner_type=semgrep' \
      #       -F 'origin_id=${{ env.origin_id }}' \
      #       -F 'project_name=${{ github.repository }}' \
      #       -F 'user_id=1'
      
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤
      - name: Check upload status
        if: steps.upload_trivy.outcome == 'failure' || steps.upload_bandit.outcome == 'failure'
        run: |
          echo "‚ùå Failed to upload one or more reports"
          exit 1
      
      # –í—ã–∑–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
      - name: Generate final report
        run: |
          echo "‚è≥ Generating report for pipeline: ${{ env.origin_id }}"
          
          RESPONSE=$(curl -X 'GET' \
            "${API_BASE_URL}${GENERATE_ENDPOINT}/${{ env.origin_id }}" \
            -H 'accept: application/json' \
            -w "%{http_code}" \
            -o response.json \
            --silent)
          
          if [[ $RESPONSE -eq 200 ]]; then
            echo "‚úÖ Report generation initiated successfully"
            cat response.json
          else
            echo "‚ùå Failed to generate report. HTTP Status: ${RESPONSE}"
            cat response.json
            exit 1
          fi
      
      # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ env.origin_id }}
          path: reports/
          retention-days: 30
      
      - name: Summary
        if: always()
        run: |
          echo "## üîí Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "Pipeline ID: \`${{ env.origin_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Repository: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Commit SHA: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Trivy: ${{ steps.upload_trivy.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Bandit: ${{ steps.upload_bandit.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Report generation initiated" >> $GITHUB_STEP_SUMMARY

  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º –≤ —Ä–∞–∑–Ω—ã—Ö –¥–∂–æ–±–∞—Ö
  parallel-scanners:
    runs-on: ubuntu-latest
    if: false  # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ true, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –¥–∂–æ–±—ã
    strategy:
      fail-fast: false
      matrix:
        scanner: [trivy, bandit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup scanner and run
        run: |
          echo "Running ${{ matrix.scanner }} scanner"
          # –ó–¥–µ—Å—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞
